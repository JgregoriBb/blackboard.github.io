<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:100,200,300,400,500,600,700,800,900&subset=latin,latin-ext'
        rel='stylesheet' type='text/css'/>
    <link href='https://fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic,700italic'
        rel='stylesheet' type='text/css'/>
    <link href="https://developer.blackboard.com/assets/portal/menu-styles.css" rel='stylesheet' type='text/css' />
    <link href="https://developer.blackboard.com/assets/portal/main-styles.css" rel="stylesheet" type="text/css" />
    <link href="https://developer.blackboard.com/assets/portal/styles_ultra.css" rel="stylesheet" type="text/css" />
    <link href="https://developer.blackboard.com/assets/portal/dev-portal.css" rel="stylesheet" type="text/css" />
    <link href="/assets/css/styles.css" rel="stylesheet" type="text/css" />

    <title></title>
    
    <link rel="shortcut icon" type="image/x-icon" href='https://developer.blackboard.com/assets/portal/favicon.ico'>
    <script>
        /* Set the width of the side navigation to 250px */
        function openNav() {
            document.getElementById("mySidenav").style.width = "500px";
            document.getElementById("main").style.marginLeft = "500px";
            document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
        }

        /* Set the width of the side navigation to 0 */
        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
            document.body.style.backgroundColor = "white";
        }
    </script>
    <script>
      /* Loop through all dropdown buttons to toggle between hiding and showing its dropdown content - This allows the user to have multiple dropdowns without any conflict */
      var dropdown = document.getElementsByClassName("dropdown-btn");
      var i;
      
      for (i = 0; i < dropdown.length; i++) {
        dropdown[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var dropdownContent = this.nextElementSibling;
        if (dropdownContent.style.display === "block") {
        dropdownContent.style.display = "none";
        } else {
        dropdownContent.style.display = "block";
        }
        });
      }
    </script>
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/dvba/Solution%20to%20a%20PostgreSQL%20Error%20In%20the%20Developer%20Virtual%20Machine.html" />
<meta property="og:url" content="http://localhost:4000/dvba/Solution%20to%20a%20PostgreSQL%20Error%20In%20the%20Developer%20Virtual%20Machine.html" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/dvba/Solution%20to%20a%20PostgreSQL%20Error%20In%20the%20Developer%20Virtual%20Machine.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <div id='top-content'>
    <div id="header" class='header-min-width'>
        <div id="header-logos">
            <div id="header-logos-left-container" class='inline-box'>
                <a id="bb-home-logo-link" href="http://www.blackboard.com" target="_blank"><img class="bb-home-logo-image" src="https://developer.blackboard.com/assets/images/bb_logo_subpages.png" alt="Blackboard"/></a>
            </div>
            <div id="header-logos-right-container" class='inline-box'>
                
                    <a href="Contact.html" class="header-section-link">Contact Us</a>
                
                    <a href="https://community.blackboard.com/developers" class="header-section-link">Community</a>
                
                    <a href="https://developer.blackboard.com" class="header-section-link">Developer Portal</a>
                
                    <a href="BECOME%20AN%20OFFICIAL%20BLACKBOARD%20PARTNER!.html" class="header-section-link">Become a Partner</a>
                
                    <a href="/Get%20Involved.html" class="header-section-link">Get Involved</a>
                
            </div>
            <br class="clearBoth"/>
        </div>
            
        <br />
        <div class="wrap">
            <div id="subhead-section" class="subhead-icon-header-interaction">
                <h1 style="color: white;">Developer Documentation</h1>
            </div>
        </div>
    </div>
</div>
    <nav style='background-color: black;'>
  
    <a href="/" class="header-section-link">Home</a>
  
    <a href="/learn/Integrate%20with%20Blackboard%20Learn.html" class="header-section-link">Learn</a>
  
    <a href="/collab/Getting%20Started%20With%20The%20Blackboard%20Collaborate%20REST%20APIs.html" class="header-section-link">Collab</a>
  
    <a href="/connecttxt/Blackboard%20ConnectTxt%20Developer%20Documentation.html" class="header-section-link">ConnectTxt</a>
  
    <a href="/mobile/Blackboard%20App%20for%20Students%20Launch%20Schema.html" class="header-section-link">Mobile</a>
  
    <a href="/openlms/Blackboard%20Open%20LMS%20Approved%20Plugin%20Program%20(MAP).html" class="header-section-link">OpenLMS</a>
  
    <a href="/dvba/What%20is%20a%20DVBA%3F.html" class="header-section-link">DVBA</a>
  
    <a href="/standards/Welcome%20To%20Standards.html" class="header-section-link">Standards</a>
  
</nav>
    <section>
      <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a><br>
    
        <a href="What%20is%20a%20DVBA%3F.html" class="header-section-link" >DVBA Home</a><br />
    
        <a href="Using%20the%20Blackboard%20Learn%20AMI%20for%20REST%20and%20LTI%20Development.html" class="header-section-link" >Developer AMI</a><br />
    
        <a href="Developer%20Virtual%20Machine%20-%20DVM.html" class="header-section-link" >DVM</a><br />
    
</div>
      
<!-- Add all page content inside this div if you want the side nav to push page content to the right (not used if you only want the sidenav to sit on top of the page -->
<div id="main">
    <!-- Use any element to open the sidenav -->
    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776;</span>

    <h1 id="solution-to-a-postgresql-error-in-the-developer-virtual-machine">Solution to a PostgreSQL Error In the Developer Virtual Machine</h1>
<p><em>Author: Mark Bykerk Kauffman</em><br />
<em>Categories: []</em><br />
<em>Tags: [‘postgresql’, ‘developer virtual machine’, ‘dvm’, ‘developer’]</em></p>
<hr />

<p>Recently I ran across an interesting issue while helping a Partner who uses
the DVM exclusively for development. Changing some user’s Institution role
resulted in a screen indicating a database error. Looking through the logs/bb-
sqlerror-log.txt file we saw entries like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2016-02-19 22:39:34 +0000 - { call user_roles_cr(users_pk1 := , institution_roles_pk1 := , row_status := , data_src_pk1 := , ) } failed. - org.postgresql.util.PSQLException: ERROR: cursor "

cursor0001" already in use

Where: PL/pgSQL function layout_module_group_trg_ins_tf() line 27 at FOR over
cursor
</code></pre></div></div>

<p>It turns out that the DVMs have several Postgres procedures and triggers that
are using the same cursor names, causing the “already in use” contention. This
issue impacts April 2014, October 2014, and Q2 2015 DVMS. You can correct for
for this now with the following procedure.</p>

<ol>
  <li>
    <p>Create a backup image/snapshot of the system you’re going to work with. For
example with Virtualbox I can click to create a snapshot that I can roll back
to.</p>
  </li>
  <li>
    <p>Open a terminal window that you can cut and paste code into. This is
important for getting the SQL code provided below exactly right. On my Mac I
opened a terminal.</p>
  </li>
  <li>
    <p>From the terminal ssh into the DVM. However you get here doesn’t matter -
we’re just after the cut/paste ability.</p>
  </li>
  <li>Switch to root.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo su -
</code></pre></div>    </div>
  </li>
  <li>Shutdown Learn.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cd /usr/local/blackboard/tools/admin
# ./ServiceController.sh services.stop
</code></pre></div>    </div>
  </li>
  <li>
    <p>Tail the appropriate logs/tomcat/stdout-stderr file until the Learn app
stops. Use ps -ef | grep java to ensure no Java code is running.</p>
  </li>
  <li>Switch to the postgres user. Start the psql command line interpreter.
Connect to the BBLEARN database.
```
    <h1 id="sudo-su---postgres">sudo su - postgres</h1>
    <p>$ psql</p>
  </li>
</ol>

<p>postgres=# \connect BBLEARN</p>

<p>You are now connected to the database “BBLEARN” as user “postgres”.
BBLEARN=#</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
8. Now run following SQL which should correct the issue.

First copy and paste the block of SQL below into the window you have open,
right after the # that is displayed, then hit enter. Copy and paste everything
up to and including the line $$ LANGUAGE plpgsql;

</code></pre></div></div>
<p>CREATE OR REPLACE FUNCTION layout_module_group_trg_ins_tf() RETURNS trigger AS
<script type="math/tex">% <![CDATA[
DECLARE
temp_pk1 bigint;
lmg_cur0 cursor for
SELECT new.layout_pk1 layout_pk1, defl.pk1 default_layout_pk1
FROM layout l, layout defl
WHERE new.layout_pk1=l.pk1
AND l.layout_family_pk1 = defl.layout_family_pk1
AND defl.default_ind='Y' AND defl.pk1 <> new.layout_pk1;
BEGIN
FOR currow IN lmg_cur0
LOOP
DECLARE
--Renamed alias to position1 as it is a reserved word
lmg_cur1 cursor for
SELECT mmg.module_pk1 module_pk1,
ml.column_number column_number, ml.position position1
FROM module_module_group mmg, module_layout ml
WHERE mmg.module_group_pk1 = new.module_group_pk1
AND mmg.module_pk1 = ml.module_pk1
AND ml.layout_pk1 = currow.default_layout_pk1
AND mmg.module_pk1 NOT IN (
SELECT module_pk1
FROM module_layout
WHERE layout_pk1=currow.layout_pk1);
BEGIN
FOR currow1 in lmg_cur1
LOOP
temp_pk1 := module_layout_cr
(module_pk1 := currow1.module_pk1,
layout_pk1 := currow.layout_pk1,
column_number := currow1.column_number,
"position" := currow1.position1,
manually_added_ind := 'N',
minimized_ind := 'N'
);
END LOOP;
END;
END LOOP;
RETURN NEW;
END; %]]></script> LANGUAGE plpgsql;</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>After you hit the Enter key, you should see CREATE FUNCTION displayed in the
terminal window. You can check that you've actually changed the function with
the following:
</code></pre></div></div>
<p>BBLEARN=# select proname,prosrc from pg_proc where
proname=’layout_module_group_trg_ins_tf’;</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Second copy and paste the block of SQL below into the window you have open,
right after the #, then hit enter. Copy and paste everything up to and
including the line $$ LANGUAGE plpgsql;
</code></pre></div></div>
<p>CREATE OR REPLACE FUNCTION users_portal_trg_upd_tf() RETURNS trigger AS <script type="math/tex">% <![CDATA[
DECLARE
lmg_pk1 bigint;
v_old_ir_pk1 bigint;
v_users_pk1 bigint;
v_count int;
cursor0001 cursor for
SELECT l.pk1 layout_pk1, img.pk1 new_mg_pk1, dmg.pk1 old_mg_pk1, l.users_pk1
v_users_pk1 , old.institution_roles_pk1 v_old_ir_pk1
FROM layout l, module_group img, module_group dmg
WHERE l.users_pk1=new.pk1
AND img.institution_roles_pk1=new.institution_roles_pk1
AND dmg.institution_roles_pk1=old.institution_roles_pk1
AND new.pk1=old.pk1
AND new.institution_roles_pk1 <>old.institution_roles_pk1;
BEGIN
FOR currow1 IN cursor0001
LOOP
v_count =0;
SELECT count(*) INTO v_count FROM layout_module_group
where layout_pk1=currow1.layout_pk1 and module_group_pk1=currow1.new_mg_pk1;
IF(v_count=0) THEN
lmg_pk1 := layout_module_group_cr
(layout_pk1 := currow1.layout_pk1,
module_group_pk1 := currow1.new_mg_pk1
);
END IF;
v_count =0;
SELECT count(*) INTO v_count FROM user_roles
where users_pk1=currow1.v_users_pk1 and
institution_roles_pk1=currow1.v_old_ir_pk1;
IF(v_count=0) THEN
perform layout_module_group_rm
(layout_pk1 := currow1.layout_pk1,
module_group_pk1 := currow1.old_mg_pk1
);
END IF;
END LOOP;
RETURN NEW;
END; %]]></script> LANGUAGE plpgsql;</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
9. Quit Postgres
</code></pre></div></div>
<p>BBLEARN=#\q</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
10. Exit back to root.
</code></pre></div></div>
<p>$ exit
```</p>

<ol>
  <li>Start Learn. Tail the appropriate logs/tomcat/stdout-stderr file to ensure
Learn is really started, then test.</li>
</ol>


</div>
    </section>
  </body>
</html>